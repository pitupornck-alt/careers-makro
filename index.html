<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>‡∏£‡πà‡∏ß‡∏°‡∏á‡∏≤‡∏ô‡∏Å‡∏±‡∏ö‡πÄ‡∏£‡∏≤</title>

  <style>
    :root { --max: 1100px; }
    body { margin:0; font-family: system-ui, -apple-system, "Segoe UI", sans-serif; background:#f6f7fb; color:#111; }
    
    /* === ‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏Å‡πâ Header === */
    /* ‡∏õ‡∏£‡∏±‡∏ö‡∏™‡∏µ‡πÄ‡∏õ‡πá‡∏ô Gradient ‡πÇ‡∏ó‡∏ô‡πÅ‡∏î‡∏á (Makro) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ Logo ‡∏ö‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏Ç‡∏≤‡∏ß‡∏î‡∏π‡πÄ‡∏î‡πà‡∏ô */
    header { padding:40px 18px; color:#fff; background: linear-gradient(120deg, #dc2626, #ef4444); }
    
    header .wrap { 
      max-width: var(--max); 
      margin:auto; 
      display: flex; 
      align-items: center; 
      gap: 24px; 
      justify-content: space-between; /* ‡∏î‡∏±‡∏ô‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡πÉ‡∏´‡πâ‡∏´‡πà‡∏≤‡∏á‡∏Å‡∏±‡∏ô */
    }
    
    /* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏£‡∏π‡∏õ Logo (‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏Ç‡∏≤‡∏ß) */
    header .logo {
      width: 120px;         /* ‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î‡πÉ‡∏´‡πâ‡πÉ‡∏´‡∏ç‡πà‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö SVG */
      height: 120px;
      object-fit: contain;
      background: #fff;     /* ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏™‡∏µ‡∏Ç‡∏≤‡∏ß */
      border-radius: 16px;
      padding: 16px;        /* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏∞‡∏¢‡∏∞‡∏Ç‡∏≠‡∏ö‡∏†‡∏≤‡∏¢‡πÉ‡∏ô */
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      flex-shrink: 0;
    }

    header .header-text { flex: 1; }
    header h1 { margin:0 0 8px; font-size:40px; line-height: 1.1; }
    header p { margin:0; font-size:18px; opacity:.95; }

    /* ‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ (Mobile) */
    @media (max-width: 600px) {
      /* ‡πÉ‡∏ä‡πâ column-reverse ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ Logo (‡∏ï‡∏±‡∏ß‡∏ó‡∏µ‡πà 2 ‡πÉ‡∏ô HTML) ‡πÄ‡∏î‡πâ‡∏á‡πÑ‡∏õ‡∏≠‡∏¢‡∏π‡πà‡∏ö‡∏ô‡∏™‡∏∏‡∏î */
      header .wrap { flex-direction: column-reverse; text-align: center; gap: 16px; }
      header h1 { font-size: 32px; }
      header .logo { width: 90px; height: 90px; }
    }
    /* ================================== */

    main { max-width: var(--max); margin:auto; padding:24px 18px 60px; }
    .card { background:#fff; border-radius:16px; padding:18px; box-shadow:0 10px 28px rgba(0,0,0,.08); margin-bottom:16px; }
    .row { display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
    .pill { background:#eef2ff; color:#3730a3; font-weight:700; font-size:13px; padding:6px 12px; border-radius:999px; }
    .muted { opacity:.7; }

    input, select { padding:10px 12px; border-radius:12px; border:1px solid rgba(0,0,0,.15); font-size:14px; background:#fff; }
    .btn { border:0; border-radius:12px; padding:10px 16px; font-weight:700; cursor:pointer; }
    .btn.primary { background:#111827; color:#fff; }
    .btn.ghost { background:#eef2ff; color:#3730a3; }

    .grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(280px,1fr)); gap:12px; margin-top:12px; }
    .job { border:1px solid rgba(0,0,0,.1); border-radius:14px; padding:16px; background:#fff; transition: transform 0.2s; }
    .job:hover { transform: translateY(-2px); border-color: #dc2626; /* ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏µ Border ‡∏ï‡∏≠‡∏ô Hover ‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏î‡∏á */ }
    .job h3 { margin:0 0 10px; font-size:18px; line-height:1.4; color: #111827; }
    .meta { font-size:13px; opacity:.9; color: #4b5563; }
    .meta div { margin:4px 0; display:flex; align-items:center; gap:6px; }
    
    .status-badge { display:inline-block; font-size:11px; padding:2px 8px; border-radius:4px; font-weight:bold; }
    .status-open { background:#dcfce7; color:#166534; }
    .status-closed { background:#fee2e2; color:#991b1b; }

    iframe { width:100%; height:800px; border:0; border-radius:16px; background:#fff; margin-top:12px; }
    
    .loader { border: 4px solid #f3f3f3; border-top: 4px solid #dc2626; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 20px auto; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>
</head>

<body>
<header>
  <div class="wrap">
    <!-- ‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° (‡∏¢‡πâ‡∏≤‡∏¢‡∏°‡∏≤‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏≠‡∏¢‡∏π‡πà‡∏ã‡πâ‡∏≤‡∏¢) -->
    <div class="header-text">
      <h1>‡∏£‡πà‡∏ß‡∏°‡∏á‡∏≤‡∏ô‡∏Å‡∏±‡∏ö‡πÄ‡∏£‡∏≤</h1>
      <p>‡∏î‡∏π‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ß‡πà‡∏≤‡∏á ‡πÅ‡∏•‡∏∞‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ (‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î)</p>
    </div>

    <!-- ‡∏™‡πà‡∏ß‡∏ô Logo (‡∏¢‡πâ‡∏≤‡∏¢‡∏°‡∏≤‡πÑ‡∏ß‡πâ‡∏´‡∏•‡∏±‡∏á ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏≠‡∏¢‡∏π‡πà‡∏Ç‡∏ß‡∏≤) -->
    <img id="companyLogo" 
         src="" 
         class="logo" 
         alt="Makro Logo" 
         referrerpolicy="no-referrer"
         onerror="this.style.display='none'">
  </div>
</header>

<main>
  <!-- ‡∏™‡πà‡∏ß‡∏ô‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ -->
  <section class="card">
    <div class="row" style="justify-content:space-between">
      <div>
        <span class="pill">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏á‡∏≤‡∏ô</span>
        <div class="muted" style="margin-top:4px; font-size:14px;">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤ ‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ó‡∏µ‡πà‡∏™‡∏ô‡πÉ‡∏à</div>
      </div>
      <button class="btn primary" id="refreshBtn">üîÑ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
    </div>

    <div class="row" style="margin-top:16px">
      <input id="q" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á..." style="flex:1;min-width:200px">
      <select id="filterBranch" style="min-width:150px"><option value="">‡∏ó‡∏∏‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤</option></select>
      <button class="btn ghost" id="clearBtn">‡∏•‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á</button>
    </div>
  </section>

  <!-- ‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ -->
  <section class="card">
    <div id="statusMsg" class="muted">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>
    <div id="jobs" class="grid"></div>
  </section>

  <!-- ‡∏™‡πà‡∏ß‡∏ô‡πÉ‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£ -->
  <section class="card" id="applySection" style="display:none;">
    <span class="pill">‡πÉ‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏á‡∏≤‡∏ô</span>
    <p class="muted" style="margin-top:8px">‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÉ‡∏ô‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á: <b id="applyPositionName">...</b></p>
    <!-- Microsoft Forms iframe ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÉ‡∏™‡πà‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà -->
    <div id="iframeContainer"></div>
  </section>
</main>

<script>
/* ================= CONFIG (‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ) ================= */

// 1. ‡πÉ‡∏™‡πà‡∏•‡∏¥‡∏á‡∏Å‡πå CSV ‡∏à‡∏≤‡∏Å Google Sheet
const GOOGLE_SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRNspwvCPUWv4QOCeQNiC30GdqHfOkPfKjCpy-aeE8lXx0jn2zRnGEbiQfoBWcEb5JBg4R6parrFJUr/pub?output=csv"; 

// 2. ‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û Logo (‡πÉ‡∏ä‡πâ‡πÑ‡∏ü‡∏•‡πå SVG ‡∏à‡∏≤‡∏Å CPAxtra)
const COMPANY_LOGO_URL = "https://www.cpaxtra.com/storage/logo-makro.svg";

// 3. Microsoft Form Link
const FORM_BASE_URL = "https://forms.office.com/r/wabJfczd4Z";

// =========================================================

/* ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ Global ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• */
let allJobs = [];
let branches = new Set();

/* DOM Elements */
const elQ = document.getElementById("q");
const elFilterBranch = document.getElementById("filterBranch");
const elClearBtn = document.getElementById("clearBtn");
const elStatus = document.getElementById("statusMsg");
const elJobs = document.getElementById("jobs");
const elRefreshBtn = document.getElementById("refreshBtn");
const elApplySection = document.getElementById("applySection");
const elApplyPositionName = document.getElementById("applyPositionName");
const elIframeContainer = document.getElementById("iframeContainer");

/* ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö */
window.onload = init;

async function init() {
  // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Logo ‡∏ú‡πà‡∏≤‡∏ô JS
  if (COMPANY_LOGO_URL) {
    document.getElementById("companyLogo").src = COMPANY_LOGO_URL;
  }

  await loadData();
  
  // Event Listeners
  elQ.addEventListener("input", renderJobs);
  elFilterBranch.addEventListener("change", renderJobs);
  elClearBtn.addEventListener("click", () => {
    elQ.value = "";
    elFilterBranch.value = "";
    renderJobs();
  });
  elRefreshBtn.addEventListener("click", loadData);
}

/* ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Google Sheets */
async function loadData() {
  elStatus.innerHTML = '<div class="loader"></div>';
  elJobs.innerHTML = "";
  
  try {
    const response = await fetch(GOOGLE_SHEET_CSV_URL);
    
    if (!response.ok) throw new Error("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ");
    
    const text = await response.text();
    const data = parseCSV(text); 

    allJobs = data.map(row => ({
      code: row[0] || "",
      branch: row[1] || "",
      position: row[2] || "",
      status: row[3] || "Closed",
      desc: row[4] || ""
    })).filter(job => job.position && job.branch);

    updateBranchDropdown();
    renderJobs();
    elStatus.textContent = `‡∏û‡∏ö‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏á‡∏≤‡∏ô‡∏ß‡πà‡∏≤‡∏á ${allJobs.length} ‡∏≠‡∏±‡∏ï‡∏£‡∏≤ (‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÄ‡∏°‡∏∑‡πà‡∏≠: ${new Date().toLocaleTimeString('th-TH')})`;

  } catch (error) {
    console.error(error);
    elStatus.innerHTML = `<span style="color:red">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message} <br>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏•‡∏¥‡∏á‡∏Å‡πå Google Sheet CSV</span>`;
  }
}

/* ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏á‡∏≤‡∏ô */
function renderJobs() {
  const searchText = elQ.value.toLowerCase();
  const branchFilter = elFilterBranch.value;

  const filtered = allJobs.filter(job => {
    const matchSearch = job.position.toLowerCase().includes(searchText) || 
                        job.branch.toLowerCase().includes(searchText);
    const matchBranch = branchFilter === "" || job.branch === branchFilter;
    const matchStatus = job.status.toLowerCase().trim() === "open";

    return matchSearch && matchBranch && matchStatus;
  });

  elJobs.innerHTML = "";

  if (filtered.length === 0) {
    elJobs.innerHTML = `<div style="grid-column:1/-1;text-align:center;padding:20px;opacity:0.6">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</div>`;
    return;
  }

  filtered.forEach(job => {
    const card = document.createElement("div");
    card.className = "job";
    card.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:start;">
        <span class="status-badge status-open">‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£</span>
        <small class="muted">#${job.code}</small>
      </div>
      <h3>${job.position}</h3>
      <div class="meta">
        <div>üè¢ ‡∏™‡∏≤‡∏Ç‡∏≤: <strong>${job.branch}</strong></div>
        <div>üìù ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î: ${job.desc || '-'}</div>
      </div>
      <button class="btn ghost" style="width:100%; margin-top:12px;" onclick="openApplyForm('${job.position}', '${job.branch}')">
        ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ô‡∏µ‡πâ üëâ
      </button>
    `;
    elJobs.appendChild(card);
  });
}

/* ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏á‡∏≤‡∏ô */
window.openApplyForm = function(position, branch) {
  elApplySection.style.display = "block";
  elApplyPositionName.textContent = `${position} (${branch})`;
  elApplySection.scrollIntoView({ behavior: "smooth" });

  const finalUrl = FORM_BASE_URL; 
  elIframeContainer.innerHTML = `<iframe src="${finalUrl}" allowfullscreen></iframe>`;
}

/* ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Dropdown ‡∏™‡∏≤‡∏Ç‡∏≤ */
function updateBranchDropdown() {
  const branches = [...new Set(allJobs.map(j => j.branch))].sort();
  const currentVal = elFilterBranch.value;
  
  elFilterBranch.innerHTML = '<option value="">‡∏ó‡∏∏‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤</option>';
  branches.forEach(b => {
    const opt = document.createElement("option");
    opt.value = b;
    opt.textContent = b;
    elFilterBranch.appendChild(opt);
  });
  
  if (branches.includes(currentVal)) elFilterBranch.value = currentVal;
}

/* ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏õ‡∏•‡∏á CSV */
function parseCSV(text) {
  const lines = text.split(/\r?\n/);
  const result = [];
  
  for (let i = 1; i < lines.length; i++) { 
    if (!lines[i].trim()) continue;
    
    const row = lines[i].match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g);
    const fallbackRow = lines[i].split(',');
    
    const cleanRow = (row || fallbackRow).map(col => 
      col.replace(/^"|"$/g, '').replace(/""/g, '"').trim()
    );
    
    result.push(cleanRow);
  }
  return result;
}
</script>

</body>
</html>
