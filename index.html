<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>ร่วมงานกับเรา</title>

  <style>
    :root { --max: 1100px; }
    body { margin:0; font-family: system-ui, -apple-system, "Segoe UI", sans-serif; background:#f6f7fb; color:#111; }
    header { padding:64px 18px; color:#fff; background: linear-gradient(120deg, #4f46e5, #6366f1); }
    header .wrap { max-width: var(--max); margin:auto; }
    header h1 { margin:0 0 8px; font-size:40px; }
    header p { margin:0; font-size:18px; opacity:.95; }

    main { max-width: var(--max); margin:auto; padding:24px 18px 60px; }
    .card { background:#fff; border-radius:16px; padding:18px; box-shadow:0 10px 28px rgba(0,0,0,.08); margin-bottom:16px; }
    .row { display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
    .pill { background:#eef2ff; color:#3730a3; font-weight:700; font-size:13px; padding:6px 12px; border-radius:999px; }
    .muted { opacity:.7; }
    .hint { font-size:13px; line-height:1.45; }

    input, select { padding:10px 12px; border-radius:12px; border:1px solid rgba(0,0,0,.15); font-size:14px; background:#fff; }
    .btn { border:0; border-radius:12px; padding:10px 16px; font-weight:700; cursor:pointer; }
    .btn.primary { background:#111827; color:#fff; }
    .btn.ghost { background:#eef2ff; color:#3730a3; }

    .grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(260px,1fr)); gap:12px; margin-top:12px; }
    .job { border:1px solid rgba(0,0,0,.1); border-radius:14px; padding:14px; }
    .job h3 { margin:0 0 6px; font-size:18px; }
    .meta { font-size:13px; opacity:.9; }
    .meta div { margin:2px 0; }

    .badge {
      display:inline-block;
      font-size:12px;
      font-weight:700;
      padding:4px 10px;
      border-radius:999px;
      background:#f3f4f6;
      color:#111827;
      margin-top:8px;
    }

    .ok { background:#ecfeff; border:1px solid rgba(8,145,178,.25); color:#155e75; padding:12px; border-radius:12px; margin-top:12px; }
    .error { background:#fff1f2; border:1px solid rgba(190,18,60,.25); color:#9f1239; padding:12px; border-radius:12px; margin-top:12px; }

    code { background:#111827; color:#fff; padding:2px 6px; border-radius:6px; }
    iframe { width:100%; height:1200px; border:0; border-radius:16px; }
  </style>
</head>

<body>
<header>
  <div class="wrap">
    <h1>ร่วมงานกับเรา</h1>
    <p>ดูตำแหน่งว่าง และสมัครงานได้ทันที (ไม่ต้องล็อกอิน)</p>
  </div>
</header>

<main>
  <section class="card">
    <div class="row" style="justify-content:space-between">
      <div>
        <span class="pill">ตำแหน่งว่าง</span>
        <div class="muted hint">ดึงข้อมูลจากไฟล์ CSV/TSV ใน GitHub</div>
      </div>
      <button class="btn primary" onclick="document.getElementById('apply').scrollIntoView({behavior:'smooth'})">
        สมัครงาน
      </button>
    </div>

    <div class="row" style="margin-top:12px">
      <input id="q" placeholder="ค้นหา (ตำแหน่ง/สาขา/รหัสสาขา/สถานะ)..." style="flex:1;min-width:240px">
      <select id="filterStatus"><option value="">ทุกสถานะ</option></select>
      <select id="filterBranch"><option value="">ทุกสาขา</option></select>
      <button class="btn ghost" id="clearBtn">ล้างตัวกรอง</button>
    </div>
  </section>

  <section class="card">
    <div id="summary" class="muted">กำลังโหลดข้อมูล...</div>
    <div id="jobs" class="grid"></div>
    <div id="msg"></div>
    <div id="debug" class="muted hint" style="margin-top:10px;"></div>
  </section>

  <section class="card" id="apply">
    <span class="pill">สมัครงาน</span>
    <p class="muted">กรอกแบบฟอร์มด้านล่างได้เลย</p>
    <iframe src="https://forms.office.com/r/wabJfczd4Z" loading="lazy"></iframe>
  </section>
</main>

<script>
/* ================= CONFIG ================= */
const CSV_FILE_NAME = "ประกาศตำแหน่งงานว่างสาขา.csv";
const CSV_URL = "./" + encodeURI(CSV_FILE_NAME);

/* ================= UTIL ================= */
const norm = s => (s||"")
  .toLowerCase()
  .replace(/\uFEFF/g,"")  // BOM
  .replace(/\s+/g,"")
  .replace(/[_-]/g,"");

function detectDelimiter(text) {
  // ใช้บรรทัดแรก (header) นับจำนวนตัวคั่นที่เป็นไปได้: tab, comma, semicolon
  const firstLine = (text.split(/\r?\n/)[0] || "");
  const tab   = (firstLine.match(/\t/g) || []).length;
  const comma = (firstLine.match(/,/g)  || []).length;
  const semi  = (firstLine.match(/;/g)  || []).length;

  // เลือกตัวที่มีจำนวนมากสุด
  if (tab >= comma && tab >= semi && tab > 0) return "\t";
  if (semi > comma) return ";";
  return ",";
}

function parseDelimited(text, delimiter) {
  // Parser แบบรองรับ quoted fields พื้นฐาน ใช้ได้กับ , ; และ \t
  const rows = [];
  let row=[], cur="", inQ=false;

  for (let i=0;i<text.length;i++) {
    const c=text[i], n=text[i+1];

    if (c === '"') {
      if (inQ && n === '"') { cur+='"'; i++; }
      else inQ = !inQ;
      continue;
    }

    if (!inQ && c === delimiter) { row.push(cur.trim()); cur=""; continue; }

    if (!inQ && (c === '\n' || c === '\r')) {
      if (c === '\r' && n === '\n') i++;
      row.push(cur.trim());
      if (row.some(v=>v.length>0)) rows.push(row);
      row=[]; cur=""; continue;
    }

    cur += c;
  }

  if (cur.length || row.length) {
    row.push(cur.trim());
    if (row.some(v=>v.length>0)) rows.push(row);
  }
  return rows;
}

function headerIndex(headers) {
  const map={};
  headers.forEach((h,i)=>map[norm(h)]=i);
  const pick = arr => {
    for (const a of arr) {
      const k = norm(a);
      if (k in map) return map[k];
    }
    return -1;
  };

  // *** MAP ตาม header ของคุณ + เผื่อชื่อใกล้เคียง ***
  return {
    branchCode: pick(["รหัสสาขา","branchcode","storecode","code"]),
    branchName: pick(["ชื่อสาขา","branchname","storename","branch","สาขา"]),
    jobTitle:   pick(["ตำแหน่งงาน","position","jobtitle","jobname","ตำแหน่ง","ตำแหน่งที่รับสมัคร"]),
    jobStatus:  pick(["สถานะตำแหน่งงาน","status","jobstatus","สถานะ"]),
    recruitPos: pick(["ตำแหน่งที่รับสมัคร","recruitposition","applyfor","ตำแหน่งรับสมัคร","ตำแหน่งสมัคร"]),
  };
}

function uniq(arr) {
  return [...new Set(arr.filter(Boolean))].sort((a,b)=>a.localeCompare(b,"th"));
}

let allRows = [];

function render() {
  const qv = q.value.toLowerCase().trim();
  const sv = filterStatus.value;
  const bv = filterBranch.value;

  const list = allRows.filter(r=>{
    const hay = `${r.branchCode} ${r.branchName} ${r.jobTitle} ${r.jobStatus} ${r.recruitPos}`.toLowerCase();
    const okQ = !qv || hay.includes(qv);
    const okS = !sv || r.jobStatus === sv;
    const okB = !bv || r.branchName === bv;
    return okQ && okS && okB;
  });

  summary.textContent = `พบ ${list.length} ตำแหน่ง (จากทั้งหมด ${allRows.length})`;

  jobs.innerHTML = list.map(r=>`
    <div class="job">
      <h3>${r.jobTitle || r.recruitPos || "-"}</h3>
      <div class="meta">
        ${r.branchName ? `<div><b>สาขา:</b> ${r.branchName}</div>` : ""}
        ${r.branchCode ? `<div><b>รหัสสาขา:</b> ${r.branchCode}</div>` : ""}
        ${r.recruitPos ? `<div><b>ตำแหน่งที่รับสมัคร:</b> ${r.recruitPos}</div>` : ""}
      </div>
      ${r.jobStatus ? `<div class="badge">สถานะ: ${r.jobStatus}</div>` : ""}
      <div style="margin-top:12px">
        <button class="btn primary" onclick="document.getElementById('apply').scrollIntoView({behavior:'smooth'})">
          สมัครตำแหน่งนี้
        </button>
      </div>
    </div>
  `).join("");
}

async function loadData() {
  try {
    const res = await fetch(CSV_URL + "?ts=" + Date.now(), { cache:"no-store" });
    if (!res.ok) throw new Error(`HTTP ${res.status}`);

    const text = await res.text();
    const delimiter = detectDelimiter(text);
    const rows = parseDelimited(text, delimiter);
    if (!rows.length) throw new Error("ไฟล์ว่าง หรืออ่านไม่ออก");

    const headers = rows[0];
    const idx = headerIndex(headers);

    debug.innerHTML =
      `ไฟล์: <code>${CSV_FILE_NAME}</code> | ตัวคั่น: <code>${delimiter === "\t" ? "\\t (TAB)" : delimiter}</code><br>` +
      `หัวคอลัมน์ที่พบ: <code>${headers.join(" | ")}</code><br>` +
      `mapping: รหัสสาขา=${idx.branchCode}, ชื่อสาขา=${idx.branchName}, ตำแหน่งงาน=${idx.jobTitle}, สถานะ=${idx.jobStatus}, ตำแหน่งที่รับสมัคร=${idx.recruitPos}`;

    if (idx.branchName === -1 && idx.jobTitle === -1 && idx.recruitPos === -1) {
      throw new Error("จับคอลัมน์หลักไม่เจอ (ชื่อสาขา/ตำแหน่งงาน/ตำแหน่งที่รับสมัคร) — ดูหัวคอลัมน์จาก Debug แล้วแจ้งผมได้");
    }

    allRows = rows.slice(1).map(r=>({
      branchCode: idx.branchCode>=0 ? (r[idx.branchCode]||"") : "",
      branchName: idx.branchName>=0 ? (r[idx.branchName]||"") : "",
      jobTitle:   idx.jobTitle>=0   ? (r[idx.jobTitle]||"")   : "",
      jobStatus:  idx.jobStatus>=0  ? (r[idx.jobStatus]||"")  : "",
      recruitPos: idx.recruitPos>=0 ? (r[idx.recruitPos]||"") : "",
    })).filter(x => x.branchName || x.jobTitle || x.recruitPos || x.jobStatus || x.branchCode);

    // เติมตัวกรอง
    filterStatus.innerHTML = `<option value="">ทุกสถานะ</option>`;
    filterBranch.innerHTML = `<option value="">ทุกสาขา</option>`;
    uniq(allRows.map(r=>r.jobStatus)).forEach(v=>filterStatus.insertAdjacentHTML("beforeend", `<option>${v}</option>`));
    uniq(allRows.map(r=>r.branchName)).forEach(v=>filterBranch.insertAdjacentHTML("beforeend", `<option>${v}</option>`));

    msg.innerHTML = `<div class="ok">โหลดข้อมูลตำแหน่งสำเร็จ</div>`;
    render();
  } catch (e) {
    console.error(e);
    summary.textContent = "โหลดข้อมูลไม่สำเร็จ";
    jobs.innerHTML = "";
    msg.innerHTML = `<div class="error"><b>โหลดข้อมูลจากไฟล์ไม่สำเร็จ</b><br><span class="hint">${e.message || e}</span></div>`;
  }
}

/* ================= EVENTS ================= */
q.oninput = render;
filterStatus.onchange = render;
filterBranch.onchange = render;
clearBtn.onclick = ()=>{ q.value=""; filterStatus.value=""; filterBranch.value=""; render(); };

loadData();
</script>

</body>
</html>
